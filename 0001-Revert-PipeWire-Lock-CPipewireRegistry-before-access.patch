From cb518f173a71286f32e7870071fa69ff53048d62 Mon Sep 17 00:00:00 2001
From: Michael Cronenworth <mike@cchtml.com>
Date: Sun, 2 Nov 2025 20:37:57 -0600
Subject: [PATCH] Revert "[PipeWire] Lock `CPipewireRegistry` before accessing"

This reverts commit c89cf388e3d0f124c88c72078a8069f37aa7164b.
---
 xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp  | 2 --
 .../cores/AudioEngine/Sinks/pipewire/PipewireRegistry.cpp | 5 ++---
 xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.h  | 8 --------
 3 files changed, 2 insertions(+), 13 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp b/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
index 5c6ff8d7c2..31d515f63a 100644
--- a/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
@@ -303,8 +303,6 @@ void CAESinkPipewire::EnumerateDevicesEx(AEDeviceInfoList& list, bool force)
   list.emplace_back(defaultDevice);
 
   auto& registry = pipewire->GetRegistry();
-  std::lock_guard lg(registry);
-
   for (const auto& [id, global] : registry.GetGlobals())
   {
     CAEDeviceInfo device;
diff --git a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.cpp b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.cpp
index 93747f0b9f..9128d79b50 100644
--- a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.cpp
@@ -44,6 +44,8 @@ void CPipewireRegistry::OnGlobalAdded(void* userdata,
                                       uint32_t version,
                                       const struct spa_dict* props)
 {
+  auto& registry = *reinterpret_cast<CPipewireRegistry*>(userdata);
+
   if (strcmp(type, PW_TYPE_INTERFACE_Node) != 0)
     return;
 
@@ -65,8 +67,6 @@ void CPipewireRegistry::OnGlobalAdded(void* userdata,
   auto properties =
       std::unique_ptr<pw_properties, PipewirePropertiesDeleter>(pw_properties_new_dict(props));
 
-  auto& registry = *reinterpret_cast<CPipewireRegistry*>(userdata);
-  std::lock_guard lg(registry);
   auto node = std::make_unique<CPipewireNode>(registry, id, type);
 
   auto& globals = registry.GetGlobals();
@@ -86,7 +86,6 @@ void CPipewireRegistry::OnGlobalAdded(void* userdata,
 void CPipewireRegistry::OnGlobalRemoved(void* userdata, uint32_t id)
 {
   auto& registry = *reinterpret_cast<CPipewireRegistry*>(userdata);
-  std::lock_guard lg(registry);
   auto& globals = registry.GetGlobals();
 
   auto it = globals.find(id);
diff --git a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.h b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.h
index 95d3db1af9..50acb280e6 100644
--- a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.h
+++ b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireRegistry.h
@@ -8,8 +8,6 @@
 
 #pragma once
 
-#include "threads/CriticalSection.h"
-
 #include <map>
 #include <memory>
 #include <string>
@@ -37,10 +35,6 @@ public:
 
   std::map<uint32_t, std::unique_ptr<CPipewireGlobal>>& GetGlobals() { return m_globals; }
 
-  // C++ BasicLockable requirements
-  void lock() { m_lock.lock(); }
-  void unlock() { m_lock.unlock(); }
-
 private:
   static void OnGlobalAdded(void* userdata,
                             uint32_t id,
@@ -65,8 +59,6 @@ private:
   std::unique_ptr<pw_registry, PipewireRegistryDeleter> m_registry;
 
   std::map<uint32_t, std::unique_ptr<CPipewireGlobal>> m_globals;
-
-  CCriticalSection m_lock;
 };
 
 } // namespace PIPEWIRE
-- 
2.51.1

