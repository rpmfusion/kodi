From 7398b4ba90c568198db3aa1989cad6d3ebe67e5d Mon Sep 17 00:00:00 2001
From: Stephan <40370954+stephan49@users.noreply.github.com>
Date: Sat, 14 Dec 2024 21:25:11 -0500
Subject: [PATCH] PipeWire: stop log spam from RequestProcess events

---
 xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp | 3 ++-
 xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.cpp | 5 +++++
 xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.h   | 2 ++
 3 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp b/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
index ab26a90bb65ab..6da58854853e7 100644
--- a/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
@@ -607,7 +607,8 @@ unsigned int CAESinkPipewire::AddPackets(uint8_t** data, unsigned int frames, un
 
   } while (true);
 
-  m_stream->TriggerProcess();
+  if (m_stream->IsDriving())
+    m_stream->TriggerProcess();
 
   return frames;
 }
diff --git a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.cpp b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.cpp
index 63e4a320d4fe8..dd7e952c0a185 100644
--- a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.cpp
@@ -73,6 +73,11 @@ void CPipewireStream::QueueBuffer(pw_buffer* buffer)
   pw_stream_queue_buffer(m_stream.get(), buffer);
 }
 
+bool CPipewireStream::IsDriving() const
+{
+  return pw_stream_is_driving(m_stream.get());
+}
+
 bool CPipewireStream::TriggerProcess() const
 {
   int ret = pw_stream_trigger_process(m_stream.get());
diff --git a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.h b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.h
index a44274ff7e398..494fa948c30ba 100644
--- a/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.h
+++ b/xbmc/cores/AudioEngine/Sinks/pipewire/PipewireStream.h
@@ -43,6 +43,8 @@ class CPipewireStream
   pw_buffer* DequeueBuffer();
   void QueueBuffer(pw_buffer* buffer);
 
+  bool IsDriving() const;
+
   bool TriggerProcess() const;
 
   void Flush(bool drain);
